name: Manual Build and Release

# æ‰‹åŠ¨è§¦å‘çš„æ„å»ºå’Œå‘å¸ƒå·¥ä½œæµ
# å…è®¸ç”¨æˆ·é€šè¿‡GitHubç•Œé¢æ‰‹åŠ¨è§¦å‘æ„å»º
on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        default: 'build'
        type: choice
        options:
          - build
          - release
          - test-only
      version_type:
        description: 'ç‰ˆæœ¬å‡çº§ç±»å‹ (ä»…åœ¨releaseæ—¶ä½¿ç”¨)'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      platforms:
        description: 'æ„å»ºå¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - macos
          - linux
      python_version:
        description: 'Pythonç‰ˆæœ¬'
        required: false
        default: '3.11'
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
      skip_tests:
        description: 'è·³è¿‡æµ‹è¯•'
        required: false
        default: false
        type: boolean
      create_draft:
        description: 'åˆ›å»ºè‰ç¨¿å‘å¸ƒ (ä»…åœ¨releaseæ—¶ä½¿ç”¨)'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: ${{ github.event.inputs.python_version || '3.11' }}
  BUILD_TYPE: ${{ github.event.inputs.build_type || 'build' }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality:
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    runs-on: ubuntu-latest
    name: ä»£ç è´¨é‡æ£€æŸ¥
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-quality-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-quality-
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 black isort mypy bandit safety
        
    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        echo "æ£€æŸ¥ä»£ç æ ¼å¼..."
        black --check src/ || echo "::warning::ä»£ç æ ¼å¼éœ€è¦ä¿®å¤"
        
    - name: å¯¼å…¥æ’åºæ£€æŸ¥
      run: |
        echo "æ£€æŸ¥å¯¼å…¥æ’åº..."
        isort --check-only src/ || echo "::warning::å¯¼å…¥æ’åºéœ€è¦ä¿®å¤"
        
    - name: Flake8æ£€æŸ¥
      run: |
        echo "è¿è¡Œflake8..."
        flake8 src/ --max-line-length=88 --extend-ignore=E203,W503 || echo "::warning::å‘ç°ä»£ç é—®é¢˜"
        
    - name: ç±»å‹æ£€æŸ¥
      run: |
        echo "ç±»å‹æ£€æŸ¥..."
        mypy src/ --ignore-missing-imports || echo "::warning::å‘ç°ç±»å‹é—®é¢˜"
        
    - name: å®‰å…¨æ£€æŸ¥
      run: |
        echo "å®‰å…¨æ£€æŸ¥..."
        bandit -r src/ -f json -o bandit-report.json || echo "::warning::å‘ç°å®‰å…¨é—®é¢˜"
        safety check --json --output safety-report.json || echo "::warning::å‘ç°ä¾èµ–å®‰å…¨é—®é¢˜"
        
    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # æµ‹è¯•
  test:
    if: ${{ github.event.inputs.skip_tests != 'true' }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            platform: linux
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos
    
    name: æµ‹è¯• (${{ matrix.platform }})
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-glx \
          libglib2.0-0 \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-shape0 \
          libxcb-xfixes0
          
    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install qt6
        
    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/AppData/Local/pip/Cache
          ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-test-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-test-
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov
        
    - name: è¿è¡Œæµ‹è¯•
      run: |
        if [ -d "tests" ] || [ -d "test" ]; then
          python -m pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing || echo "::warning::æµ‹è¯•å¤±è´¥"
        else
          echo "::warning::æœªæ‰¾åˆ°æµ‹è¯•ç›®å½•ï¼Œè·³è¿‡æµ‹è¯•"
        fi
      shell: bash
      
    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      if: matrix.os == 'ubuntu-latest'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  # æ„å»º
  build:
    needs: [quality, test]
    if: always() && (needs.quality.result == 'success' || needs.quality.result == 'skipped') && (needs.test.result == 'success' || needs.test.result == 'skipped')
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            enabled: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux' }}
          - os: windows-latest
            platform: windows
            enabled: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows' }}
          - os: macos-latest
            platform: macos
            enabled: ${{ github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos' }}
    
    name: æ„å»º (${{ matrix.platform }})
    
    steps:
    - name: è·³è¿‡æ„å»º
      if: ${{ !matrix.enabled }}
      run: echo "è·³è¿‡ ${{ matrix.platform }} å¹³å°æ„å»º"
      
    - name: æ£€å‡ºä»£ç 
      if: ${{ matrix.enabled }}
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Python
      if: ${{ matrix.enabled }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
      if: matrix.enabled && matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgl1-mesa-glx \
          libglib2.0-0 \
          libxcb-xinerama0 \
          libxcb-cursor0 \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-randr0 \
          libxcb-render-util0 \
          libxcb-shape0 \
          libxcb-xfixes0
          
    - name: å®‰è£…ç³»ç»Ÿä¾èµ– (macOS)
      if: matrix.enabled && matrix.os == 'macos-latest'
      run: |
        brew install qt6
        
    - name: ç¼“å­˜pipä¾èµ–
      if: ${{ matrix.enabled }}
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/pip
          ~/AppData/Local/pip/Cache
          ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-build-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-build-
          ${{ runner.os }}-pip-
          
    - name: å®‰è£…ä¾èµ–
      if: ${{ matrix.enabled }}
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: æ„å»ºåº”ç”¨ç¨‹åº
      if: ${{ matrix.enabled }}
      run: |
        if [ -f "scripts/build_automation.py" ]; then
          python scripts/build_automation.py
        elif [ -f "build.py" ]; then
          python build.py
        else
          echo "ä½¿ç”¨é»˜è®¤PyInstalleræ„å»º..."
          if [ "${{ matrix.platform }}" = "windows" ]; then
            python -m PyInstaller --onefile --windowed --name ScreenRecorder main.py
          elif [ "${{ matrix.platform }}" = "macos" ]; then
            python -m PyInstaller --onefile --windowed --name ScreenRecorder main.py
          else
            python -m PyInstaller --onefile --name ScreenRecorder main.py
          fi
        fi
      shell: bash
      
    - name: åˆ›å»ºä¾¿æºç‰ˆåŒ… (Windows)
      if: matrix.enabled && matrix.platform == 'windows'
      run: |
        mkdir -p portable
        cp dist/ScreenRecorder.exe portable/
        cp README.md portable/ || echo "README.md not found"
        cp LICENSE portable/ || echo "LICENSE not found"
        cd portable
        7z a ../ScreenRecorder-Windows-Portable.zip *
      shell: bash
      
    - name: åˆ›å»ºä¾¿æºç‰ˆåŒ… (macOS)
      if: matrix.enabled && matrix.platform == 'macos'
      run: |
        mkdir -p portable
        cp dist/ScreenRecorder portable/
        cp README.md portable/ || echo "README.md not found"
        cp LICENSE portable/ || echo "LICENSE not found"
        cd portable
        tar -czf ../ScreenRecorder-macOS-Portable.tar.gz *
        
    - name: åˆ›å»ºä¾¿æºç‰ˆåŒ… (Linux)
      if: matrix.enabled && matrix.platform == 'linux'
      run: |
        mkdir -p portable
        cp dist/ScreenRecorder portable/
        cp README.md portable/ || echo "README.md not found"
        cp LICENSE portable/ || echo "LICENSE not found"
        cd portable
        tar -czf ../ScreenRecorder-Linux-Portable.tar.gz *
        
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      if: ${{ matrix.enabled }}
      uses: actions/upload-artifact@v3
      with:
        name: build-${{ matrix.platform }}
        path: |
          dist/
          *.zip
          *.tar.gz
          *.dmg

  # å‘å¸ƒ
  release:
    if: ${{ github.event.inputs.build_type == 'release' }}
    needs: [build]
    runs-on: ubuntu-latest
    name: åˆ›å»ºå‘å¸ƒ
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è®¾ç½®Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        path: artifacts
        
    - name: æ•´ç†æ„å»ºäº§ç‰©
      run: |
        mkdir -p release_assets
        find artifacts -type f \( -name "*.exe" -o -name "*.dmg" -o -name "*.tar.gz" -o -name "*.zip" -o -name "ScreenRecorder" \) -exec cp {} release_assets/ \;
        ls -la release_assets/
        
    - name: ç”Ÿæˆç‰ˆæœ¬å·
      id: version
      run: |
        if [ -f "scripts/auto_release.py" ]; then
          python scripts/auto_release.py --type ${{ github.event.inputs.version_type }} --dry-run
          VERSION=$(python scripts/auto_release.py --type ${{ github.event.inputs.version_type }} --get-version)
        else
          # ç®€å•çš„ç‰ˆæœ¬ç”Ÿæˆé€»è¾‘
          CURRENT_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          
          # è§£æç‰ˆæœ¬å·
          VERSION_NUM=${CURRENT_VERSION#v}
          IFS='.' read -ra VERSION_PARTS <<< "$VERSION_NUM"
          MAJOR=${VERSION_PARTS[0]:-0}
          MINOR=${VERSION_PARTS[1]:-0}
          PATCH=${VERSION_PARTS[2]:-0}
          
          # æ ¹æ®ç±»å‹å‡çº§ç‰ˆæœ¬
          case "${{ github.event.inputs.version_type }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          VERSION="v$MAJOR.$MINOR.$PATCH"
        fi
        
        echo "æ–°ç‰ˆæœ¬: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: åˆ›å»ºGitæ ‡ç­¾
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a ${{ steps.version.outputs.version }} -m "Release ${{ steps.version.outputs.version }}"
        git push origin ${{ steps.version.outputs.version }}
        
    - name: ç”Ÿæˆå‘å¸ƒè¯´æ˜
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ğŸ‰ ScreenRecorder ${{ steps.version.outputs.version }}
        
        ### âœ¨ æ–°åŠŸèƒ½
        - æ‰‹åŠ¨è§¦å‘æ„å»ºå’Œå‘å¸ƒ
        - è·¨å¹³å°æ”¯æŒ (Windows, macOS, Linux)
        - è‡ªåŠ¨åŒ–æ„å»ºæµç¨‹
        
        ### ğŸ“¦ ä¸‹è½½
        
        #### Windows
        - `ScreenRecorder.exe` - Windowså¯æ‰§è¡Œæ–‡ä»¶
        - `ScreenRecorder-Windows-Portable.zip` - Windowsä¾¿æºç‰ˆ
        
        #### macOS
        - `ScreenRecorder` - macOSå¯æ‰§è¡Œæ–‡ä»¶
        - `ScreenRecorder-macOS-Portable.tar.gz` - macOSä¾¿æºç‰ˆ
        
        #### Linux
        - `ScreenRecorder` - Linuxå¯æ‰§è¡Œæ–‡ä»¶
        - `ScreenRecorder-Linux-Portable.tar.gz` - Linuxä¾¿æºç‰ˆ
        
        ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
        - Python ${{ env.PYTHON_VERSION }}+
        - æ”¯æŒçš„æ“ä½œç³»ç»Ÿ: Windows 10+, macOS 10.15+, Ubuntu 20.04+
        
        ### ğŸ”§ å®‰è£…è¯´æ˜
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„æ–‡ä»¶
        2. è§£å‹ï¼ˆå¦‚æœæ˜¯å‹ç¼©åŒ…ï¼‰
        3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶
        
        ---
        
        **æ„å»ºä¿¡æ¯:**
        - æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
        - Pythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}
        - æ„å»ºå¹³å°: ${{ github.event.inputs.platforms }}
        - æ„å»ºç±»å‹: ${{ github.event.inputs.build_type }}
        EOF
        
        echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT
        
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: ScreenRecorder ${{ steps.version.outputs.version }}
        body_path: ${{ steps.release_notes.outputs.release_notes_file }}
        files: release_assets/*
        draft: ${{ github.event.inputs.create_draft == 'true' }}
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # é€šçŸ¥
  notify:
    if: always()
    needs: [quality, test, build, release]
    runs-on: ubuntu-latest
    name: æ„å»ºé€šçŸ¥
    
    steps:
    - name: æ„å»ºæˆåŠŸé€šçŸ¥
      if: ${{ needs.build.result == 'success' }}
      run: |
        echo "âœ… æ„å»ºæˆåŠŸå®Œæˆï¼"
        echo "æ„å»ºç±»å‹: ${{ github.event.inputs.build_type }}"
        echo "æ„å»ºå¹³å°: ${{ github.event.inputs.platforms }}"
        echo "Pythonç‰ˆæœ¬: ${{ env.PYTHON_VERSION }}"
        
    - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
      if: ${{ needs.release.result == 'success' }}
      run: |
        echo "ğŸ‰ å‘å¸ƒæˆåŠŸåˆ›å»ºï¼"
        echo "æŸ¥çœ‹å‘å¸ƒ: ${{ github.server_url }}/${{ github.repository }}/releases"
        
    - name: æ„å»ºå¤±è´¥é€šçŸ¥
      if: ${{ needs.build.result == 'failure' || needs.release.result == 'failure' }}
      run: |
        echo "âŒ æ„å»ºæˆ–å‘å¸ƒå¤±è´¥ï¼"
        echo "è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"