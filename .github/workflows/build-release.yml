name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ (å¦‚ v1.0.0)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      tag_name:
        description: 'Release tag name (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Create resources directory
      run: |
        mkdir -p resources
        # åˆ›å»ºä¸€ä¸ªç®€å•çš„ICOæ–‡ä»¶å ä½ç¬¦
        echo "" > resources/icon.ico
    
    - name: Build Windows executable
      run: |
        python build_scripts/build_windows.py
    
    - name: Create Windows installer (NSIS)
      run: |
        # å¦‚æžœæœ‰NSISï¼Œå¯ä»¥åˆ›å»ºå®‰è£…ç¨‹åº
        # makensis installer.nsi
        echo "Windows executable built successfully"
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v3
      with:
        name: windows-build
        path: |
          dist/ScreenRecorder.exe
          installer.nsi
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/Library/Caches/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Install system dependencies
      run: |
        # å®‰è£…å¯èƒ½éœ€è¦çš„ç³»ç»Ÿä¾èµ–
        brew install portaudio
    
    - name: Create resources directory
      run: |
        mkdir -p resources
        # åˆ›å»ºä¸€ä¸ªç®€å•çš„ICNSæ–‡ä»¶å ä½ç¬¦
        touch resources/icon.icns
    
    - name: Build macOS app
      run: |
        python build_scripts/build_macos.py
    
    - name: Upload macOS artifacts
      uses: actions/upload-artifact@v3
      with:
        name: macos-build
        path: |
          dist/ScreenRecorder.app
          dist/*.dmg
        retention-days: 30

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get tag name
      id: get_tag
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
        else
          echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi
    
    - name: Download Windows artifacts
      uses: actions/download-artifact@v3
      with:
        name: windows-build
        path: ./windows-build
    
    - name: Download macOS artifacts
      uses: actions/download-artifact@v3
      with:
        name: macos-build
        path: ./macos-build
    
    - name: Create release archives
      run: |
        # åˆ›å»ºWindowså‘å¸ƒåŒ…
        cd windows-build
        zip -r ../ScreenRecorder-Windows-${{ steps.get_tag.outputs.tag_name }}.zip .
        cd ..
        
        # åˆ›å»ºmacOSå‘å¸ƒåŒ…
        cd macos-build
        if [ -f *.dmg ]; then
          cp *.dmg ../ScreenRecorder-macOS-${{ steps.get_tag.outputs.tag_name }}.dmg
        else
          tar -czf ../ScreenRecorder-macOS-${{ steps.get_tag.outputs.tag_name }}.tar.gz .
        fi
        cd ..
    
    - name: Generate release notes
      id: release_notes
      run: |
        cat > release_notes.md << 'EOF'
        ## ðŸŽ‰ çŽ°ä»£å½•å±å·¥å…· ${{ steps.get_tag.outputs.tag_name }}
        
        ### âœ¨ æ–°åŠŸèƒ½
        - é«˜è´¨é‡å±å¹•å½•åˆ¶
        - å¤šç§è§†é¢‘æ ¼å¼æ”¯æŒ (MP4, AVI, MOV)
        - éŸ³é¢‘å½•åˆ¶åŠŸèƒ½
        - åŒºåŸŸé€‰æ‹©å½•åˆ¶
        - å®žæ—¶é¢„è§ˆ
        
        ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
        - **Windowsç”¨æˆ·**: ä¸‹è½½ `ScreenRecorder-Windows-${{ steps.get_tag.outputs.tag_name }}.zip`
        - **macOSç”¨æˆ·**: ä¸‹è½½ `ScreenRecorder-macOS-${{ steps.get_tag.outputs.tag_name }}.dmg` æˆ– `.tar.gz`
        
        ### ðŸ”§ ç³»ç»Ÿè¦æ±‚
        - **Windows**: Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
        - **macOS**: macOS 10.15 (Catalina) æˆ–æ›´é«˜ç‰ˆæœ¬
        - **Python**: 3.8+ (å¦‚æžœä»Žæºç è¿è¡Œ)
        
        ### ðŸ“ æ›´æ–°æ—¥å¿—
        è¯·æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) èŽ·å–è¯¦ç»†æ›´æ–°ä¿¡æ¯ã€‚
        
        ---
        
        **å®‰è£…è¯´æ˜Ž**:
        1. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
        2. è§£åŽ‹/å®‰è£…åˆ°æœ¬åœ°
        3. è¿è¡Œåº”ç”¨ç¨‹åº
        4. é¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦æŽˆäºˆå±å¹•å½•åˆ¶æƒé™
        EOF
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_tag.outputs.tag_name }}
        name: çŽ°ä»£å½•å±å·¥å…· ${{ steps.get_tag.outputs.tag_name }}
        body_path: release_notes.md
        draft: false
        prerelease: false
        files: |
          ScreenRecorder-Windows-${{ steps.get_tag.outputs.tag_name }}.zip
          ScreenRecorder-macOS-${{ steps.get_tag.outputs.tag_name }}.*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update latest release info
      run: |
        echo "âœ… Release ${{ steps.get_tag.outputs.tag_name }} created successfully!"
        echo "ðŸ“¦ Windows package: ScreenRecorder-Windows-${{ steps.get_tag.outputs.tag_name }}.zip"
        echo "ðŸŽ macOS package: ScreenRecorder-macOS-${{ steps.get_tag.outputs.tag_name }}.*"
        echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_tag.outputs.tag_name }}"