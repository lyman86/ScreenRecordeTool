# Bugä¿®å¤æ€»ç»“æŠ¥å‘Š

## ä¿®å¤çš„é—®é¢˜

### 1. âœ… åŒºåŸŸé€‰æ‹©é”™è¯¯ä¿®å¤

**é—®é¢˜æè¿°**:
- é€‰æ‹©å½•åˆ¶åŒºåŸŸæ—¶åªèƒ½é€‰æ‹©å±å¹•é«˜åº¦çš„1/5
- é€‰æ‹©å®Œæˆåç¨‹åºè‡ªåŠ¨é€€å‡º
- é”™è¯¯ä¿¡æ¯: `TypeError: cannot unpack non-iterable int object`

**æ ¹æœ¬åŸå› **:
- åŒºåŸŸé€‰æ‹©å™¨å‘å‡ºçš„ä¿¡å·å‚æ•°æ ¼å¼ä¸åŒ¹é…
- ä¸»çª—å£æœŸæœ›æ¥æ”¶ä¸€ä¸ªå…ƒç»„ï¼Œä½†å®é™…æ¥æ”¶åˆ°4ä¸ªç‹¬ç«‹å‚æ•°
- åŒºåŸŸé€‰æ‹©å™¨çª—å£çš„å‡ ä½•è®¾ç½®æœ‰é—®é¢˜

**ä¿®å¤æ–¹æ¡ˆ**:
1. **å‚æ•°å¤„ç†ä¿®å¤**: ä¿®æ”¹ `on_region_selected()` æ–¹æ³•æ”¯æŒå¤šç§å‚æ•°æ ¼å¼
   - æ”¯æŒ4ä¸ªç‹¬ç«‹å‚æ•°: `(x, y, width, height)`
   - æ”¯æŒå…ƒç»„å‚æ•°: `((x, y, width, height),)`
   - æ”¯æŒNoneå€¼å¤„ç†
   - æ·»åŠ å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†

2. **çª—å£æ˜¾ç¤ºä¿®å¤**: æ”¹è¿›åŒºåŸŸé€‰æ‹©å™¨çª—å£çš„æ˜¾ç¤ºé€»è¾‘
   - è·å–ä¸»å±å¹•å‡ ä½•ä¿¡æ¯å¹¶æ­£ç¡®è®¾ç½®çª—å£å¤§å°
   - ç¡®ä¿çª—å£è¦†ç›–æ•´ä¸ªå±å¹•
   - æ”¹è¿›æç¤ºæ ‡ç­¾çš„ä½ç½®

**ä¿®å¤ä»£ç **:
```python
def on_region_selected(self, *args):
    """åŒºåŸŸé€‰æ‹©å®Œæˆ"""
    if len(args) == 4:
        # ç›´æ¥ä¼ é€’çš„4ä¸ªå‚æ•°
        x, y, width, height = args
        self.screen_capture.set_capture_region(x, y, width, height)
        QMessageBox.information(self, "åŒºåŸŸé€‰æ‹©", f"å·²é€‰æ‹©åŒºåŸŸ: {width}x{height} at ({x}, {y})")
    elif len(args) == 1 and args[0] is not None:
        # ä¼ é€’çš„æ˜¯å…ƒç»„
        region = args[0]
        if isinstance(region, (tuple, list)) and len(region) == 4:
            x, y, width, height = region
            self.screen_capture.set_capture_region(x, y, width, height)
            QMessageBox.information(self, "åŒºåŸŸé€‰æ‹©", f"å·²é€‰æ‹©åŒºåŸŸ: {width}x{height} at ({x}, {y})")
        else:
            # ç”¨æˆ·å–æ¶ˆé€‰æ‹©ï¼Œå›åˆ°å…¨å±æ¨¡å¼
            self.region_combo.setCurrentText("å…¨å±")
    else:
        # ç”¨æˆ·å–æ¶ˆé€‰æ‹©ï¼Œå›åˆ°å…¨å±æ¨¡å¼
        self.region_combo.setCurrentText("å…¨å±")
```

### 2. âœ… éŸ³é¢‘å½•åˆ¶NaNé”™è¯¯ä¿®å¤

**é—®é¢˜æè¿°**:
- å¼€å§‹å½•åˆ¶åå¦‚æœæœ‰å£°éŸ³è¾“å…¥ï¼Œç¨‹åºä¼šè‡ªåŠ¨é€€å‡º
- é”™è¯¯ä¿¡æ¯: 
  - `RuntimeWarning: invalid value encountered in sqrt`
  - `ValueError: cannot convert float NaN to integer`

**æ ¹æœ¬åŸå› **:
- éŸ³é¢‘æ•°æ®å¤„ç†æ—¶å¯èƒ½äº§ç”ŸNaNå€¼
- ç©ºéŸ³é¢‘æ•°æ®æˆ–æ— æ•ˆæ•°æ®å¯¼è‡´è®¡ç®—é”™è¯¯
- UIæ›´æ–°æ—¶æ²¡æœ‰å¯¹NaNå€¼è¿›è¡Œæ£€æŸ¥

**ä¿®å¤æ–¹æ¡ˆ**:
1. **éŸ³é¢‘è®¡ç®—ä¿®å¤**: æ”¹è¿› `get_volume_level()` æ–¹æ³•
   - æ·»åŠ ç©ºæ•°æ®æ£€æŸ¥
   - ä½¿ç”¨float64é¿å…æº¢å‡º
   - æ·»åŠ NaNå’Œæ— ç©·å¤§æ£€æŸ¥
   - ç¡®ä¿è¿”å›å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…

2. **UIæ›´æ–°ä¿®å¤**: æ”¹è¿› `update_ui()` æ–¹æ³•
   - æ·»åŠ æ•°å€¼æœ‰æ•ˆæ€§æ£€æŸ¥
   - å¤„ç†NaNã€æ— ç©·å¤§ç­‰ç‰¹æ®Šå€¼
   - æ·»åŠ å¼‚å¸¸å¤„ç†

**ä¿®å¤ä»£ç **:
```python
def get_volume_level(self) -> float:
    """è·å–å½“å‰éŸ³é‡çº§åˆ«ï¼ˆ0.0-1.0ï¼‰"""
    try:
        if not self.audio_buffer:
            return 0.0
        
        with self.buffer_lock:
            if self.audio_buffer:
                # è·å–æœ€æ–°çš„éŸ³é¢‘æ•°æ®
                latest_data = self.audio_buffer[-1]
                if not latest_data:
                    return 0.0
                
                # è½¬æ¢ä¸ºnumpyæ•°ç»„å¹¶è®¡ç®—RMS
                audio_array = np.frombuffer(latest_data, dtype=np.int16)
                if len(audio_array) == 0:
                    return 0.0
                
                # è®¡ç®—å‡æ–¹æ ¹å€¼ï¼Œé¿å…NaN
                mean_square = np.mean(audio_array.astype(np.float64)**2)
                if np.isnan(mean_square) or mean_square < 0:
                    return 0.0
                
                rms = np.sqrt(mean_square)
                if np.isnan(rms) or np.isinf(rms):
                    return 0.0
                
                # å½’ä¸€åŒ–åˆ°0-1èŒƒå›´
                level = rms / 32768.0
                return min(max(level, 0.0), 1.0)
        
    except Exception:
        pass
    
    return 0.0
```

## æµ‹è¯•éªŒè¯

### éŸ³é¢‘ä¿®å¤æµ‹è¯•ç»“æœ
```
æµ‹è¯•éŸ³é¢‘éŸ³é‡è®¡ç®—...
1. æµ‹è¯•ç©ºç¼“å†²åŒº... âœ“ é€šè¿‡
2. æµ‹è¯•ç©ºæ•°æ®... âœ“ é€šè¿‡  
3. æµ‹è¯•æ­£å¸¸æ•°æ®... âœ“ é€šè¿‡
4. æµ‹è¯•é›¶æ•°æ®... âœ“ é€šè¿‡
5. æµ‹è¯•æœ€å¤§å€¼æ•°æ®... âœ“ é€šè¿‡

æµ‹è¯•NaNå¤„ç†...
æµ‹è¯• æ­£å¸¸å€¼: 0.5 âœ“ é€šè¿‡
æµ‹è¯• é›¶å€¼: 0.0 âœ“ é€šè¿‡
æµ‹è¯• NaNå€¼: nan âœ“ é€šè¿‡
æµ‹è¯• æ­£æ— ç©·: inf âœ“ é€šè¿‡
æµ‹è¯• è´Ÿæ— ç©·: -inf âœ“ é€šè¿‡
æµ‹è¯• è´Ÿå€¼: -0.5 âœ“ é€šè¿‡
æµ‹è¯• å¤§å€¼: 2.0 âœ“ é€šè¿‡
```

## æŠ€æœ¯æ”¹è¿›

### 1. é”™è¯¯å¤„ç†å¢å¼º
- æ·»åŠ äº†å…¨é¢çš„å‚æ•°éªŒè¯
- æ”¹è¿›äº†å¼‚å¸¸å¤„ç†æœºåˆ¶
- å¢åŠ äº†æ•°å€¼æœ‰æ•ˆæ€§æ£€æŸ¥

### 2. æ•°æ®å®‰å…¨æ€§
- é˜²æ­¢NaNå€¼ä¼ æ’­
- ç¡®ä¿æ•°å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
- æ·»åŠ äº†ç±»å‹æ£€æŸ¥

### 3. ç”¨æˆ·ä½“éªŒæ”¹è¿›
- åŒºåŸŸé€‰æ‹©ç°åœ¨å¯ä»¥è¦†ç›–æ•´ä¸ªå±å¹•
- éŸ³é¢‘å½•åˆ¶ä¸å†å› ä¸ºNaNå€¼å´©æºƒ
- é”™è¯¯æ¢å¤æ›´åŠ ä¼˜é›…

## ä½¿ç”¨è¯´æ˜

### åŒºåŸŸé€‰æ‹©åŠŸèƒ½
1. åœ¨å½•åˆ¶è®¾ç½®ä¸­é€‰æ‹©"é€‰æ‹©åŒºåŸŸ"
2. ç‚¹å‡»"é€‰æ‹©åŒºåŸŸ"æŒ‰é’®
3. åœ¨å…¨å±è¦†ç›–çª—å£ä¸­æ‹–æ‹½é€‰æ‹©å½•åˆ¶åŒºåŸŸ
4. æ¾å¼€é¼ æ ‡å®Œæˆé€‰æ‹©ï¼Œæˆ–æŒ‰ESCå–æ¶ˆ

### éŸ³é¢‘å½•åˆ¶
1. å‹¾é€‰"å½•åˆ¶éŸ³é¢‘"é€‰é¡¹
2. å¼€å§‹å½•åˆ¶æ—¶éŸ³é¢‘ç”µå¹³æ¡ä¼šæ˜¾ç¤ºå®æ—¶éŸ³é‡
3. ç°åœ¨å¯ä»¥å®‰å…¨å¤„ç†å„ç§éŸ³é¢‘è¾“å…¥æƒ…å†µ

## å·²è§£å†³çš„å…·ä½“é—®é¢˜

âœ… **åŒºåŸŸé€‰æ‹©å´©æºƒ**: ä¿®å¤äº†å‚æ•°è§£åŒ…é”™è¯¯ï¼Œç°åœ¨å¯ä»¥æ­£å¸¸é€‰æ‹©ä»»æ„åŒºåŸŸ  
âœ… **é€‰æ‹©èŒƒå›´é™åˆ¶**: ä¿®å¤äº†çª—å£å‡ ä½•é—®é¢˜ï¼Œç°åœ¨å¯ä»¥é€‰æ‹©æ•´ä¸ªå±å¹•  
âœ… **éŸ³é¢‘å½•åˆ¶å´©æºƒ**: ä¿®å¤äº†NaNå€¼å¤„ç†ï¼ŒéŸ³é¢‘å½•åˆ¶ç°åœ¨ç¨³å®šå¯é   
âœ… **ç¨‹åºè‡ªåŠ¨é€€å‡º**: ä¸¤ä¸ªä¸»è¦å´©æºƒåŸå› éƒ½å·²ä¿®å¤ï¼Œç¨‹åºè¿è¡Œç¨³å®š  

ç°åœ¨å½•å±å·¥å…·å¯ä»¥ç¨³å®šè¿è¡Œï¼Œæ”¯æŒå®Œæ•´çš„åŒºåŸŸé€‰æ‹©å’ŒéŸ³é¢‘å½•åˆ¶åŠŸèƒ½ï¼ğŸ‰
